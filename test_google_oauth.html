<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Test - RUPP Room Booking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        .google-btn {
            display: inline-flex;
            align-items: center;
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            margin: 10px 0;
        }
        .google-btn:hover {
            background-color: #357ae8;
        }
        .google-btn img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .code-block {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .token-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Google OAuth Test - RUPP Room Booking</h1>
        
        <!-- Test Section 1: Google OAuth Login -->
        <div class="test-section">
            <h3>üîë Test 1: Google OAuth Login</h3>
            <p>Click the button below to test Google OAuth login:</p>
            
            <a href="#" class="google-btn" onclick="testGoogleLogin()">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
                Sign in with Google
            </a>
            
            <div id="googleLoginResult" class="result"></div>
        </div>
        
        <!-- Test Section 2: Manual Token Test -->
        <div class="test-section">
            <h3>üß™ Test 2: Manual Google Token Test</h3>
            <p>If you have a Google OAuth token, you can test it here:</p>
            
            <div>
                <input type="text" id="googleToken" placeholder="Enter Google OAuth token here..." style="width: 100%; padding: 10px; margin: 10px 0;">
                <button class="btn" onclick="testWithToken()">Test Token</button>
            </div>
            
            <div id="tokenTestResult" class="result"></div>
        </div>
        
        <!-- Test Section 3: Backend Endpoints -->
        <div class="test-section">
            <h3>üåê Test 3: Backend OAuth Endpoints</h3>
            <p>Test the OAuth endpoints directly:</p>
            
            <div>
                <button class="btn" onclick="testGoogleLoginEndpoint()">Test Google Login URL</button>
                <button class="btn" onclick="testGoogleCallback()">Test Google Callback</button>
                <button class="btn" onclick="checkGoogleConfig()">Check Google Config</button>
            </div>
            
            <div id="endpointTestResult" class="result"></div>
        </div>
        
        <!-- Test Section 4: Login State -->
        <div class="test-section">
            <h3>üë§ Test 4: Current Login State</h3>
            <p>Check if you're currently logged in:</p>
            
            <button class="btn" onclick="checkLoginState()">Check Login State</button>
            <button class="btn" onclick="clearTokens()">Clear All Tokens</button>
            
            <div id="loginStateResult" class="result"></div>
        </div>
        
        <!-- Instructions -->
        <div class="test-section">
            <h3>üìã Instructions</h3>
            <ol>
                <li>Make sure your Django server is running on localhost:8000</li>
                <li>Try the Google OAuth login first</li>
                <li>If login fails, check the backend endpoints</li>
                <li>Check the browser console for any errors</li>
                <li>Make sure Google OAuth is configured in Google Cloud Console</li>
            </ol>
            
            <h4>Google OAuth Configuration Checklist:</h4>
            <ul>
                <li>‚úì Google Cloud Console project created</li>
                <li>‚úì OAuth 2.0 Client ID configured</li>
                <li>‚úì Authorized redirect URIs set to: <code>http://localhost:8000/accounts/google/login/callback/</code></li>
                <li>‚úì Client ID and secret configured in Django settings</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        function showResult(elementId, message, type = 'info') {
            const resultEl = document.getElementById(elementId);
            resultEl.textContent = message;
            resultEl.className = `result ${type}`;
            resultEl.style.display = 'block';
        }
        
        function showResultHTML(elementId, html, type = 'info') {
            const resultEl = document.getElementById(elementId);
            resultEl.innerHTML = html;
            resultEl.className = `result ${type}`;
            resultEl.style.display = 'block';
        }
        
        // Test 1: Google OAuth Login
        function testGoogleLogin() {
            showResult('googleLoginResult', 'üîÑ Redirecting to Google OAuth...', 'info');
            
            // Redirect to Google OAuth
            window.location.href = `${API_BASE_URL}/accounts/google/login/`;
        }
        
        // Test 2: Manual Token Test
        async function testWithToken() {
            const token = document.getElementById('googleToken').value;
            
            if (!token) {
                showResult('tokenTestResult', '‚ùå Please enter a Google OAuth token', 'error');
                return;
            }
            
            try {
                showResult('tokenTestResult', 'üîÑ Testing token...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/auth/google/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        access_token: token
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResultHTML('tokenTestResult', `
                        <h4>‚úÖ Google OAuth Token Valid!</h4>
                        <div class="token-display">
                            <strong>Auth Token:</strong> ${data.key || 'No token returned'}<br>
                            <strong>User:</strong> ${data.user ? JSON.stringify(data.user) : 'No user info'}
                        </div>
                    `, 'success');
                    
                    // Store the token for further testing
                    localStorage.setItem('authToken', data.key);
                } else {
                    showResult('tokenTestResult', `‚ùå Token test failed: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showResult('tokenTestResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        // Test 3: Backend Endpoints
        async function testGoogleLoginEndpoint() {
            try {
                showResult('endpointTestResult', 'üîÑ Testing Google login endpoint...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/accounts/google/login/`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    showResult('endpointTestResult', '‚úÖ Google login endpoint is accessible', 'success');
                } else {
                    showResult('endpointTestResult', `‚ùå Google login endpoint failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult('endpointTestResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        async function testGoogleCallback() {
            showResult('endpointTestResult', 'üîÑ Testing Google callback endpoint...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/accounts/google/login/callback/`, {
                    method: 'GET'
                });
                
                if (response.status === 400 || response.status === 302) {
                    showResult('endpointTestResult', '‚úÖ Google callback endpoint is accessible (400/302 expected without OAuth code)', 'success');
                } else {
                    showResult('endpointTestResult', `üîÑ Google callback endpoint responded with: ${response.status}`, 'info');
                }
            } catch (error) {
                showResult('endpointTestResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        async function checkGoogleConfig() {
            showResult('endpointTestResult', 'üîÑ Checking Google OAuth configuration...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    showResultHTML('endpointTestResult', `
                        <h4>‚úÖ Django server is running</h4>
                        <p>Google OAuth Configuration:</p>
                        <ul>
                            <li>Client ID: 650291360343-q4ejdtvov5u7flp5a3unm020kbelutd4.apps.googleusercontent.com</li>
                            <li>Redirect URI should be: http://localhost:8000/accounts/google/login/callback/</li>
                            <li>Make sure these are configured in Google Cloud Console</li>
                        </ul>
                    `, 'success');
                } else {
                    showResult('endpointTestResult', '‚ùå Django server may not be running', 'error');
                }
            } catch (error) {
                showResult('endpointTestResult', `‚ùå Cannot reach Django server: ${error.message}`, 'error');
            }
        }
        
        // Test 4: Login State
        async function checkLoginState() {
            try {
                showResult('loginStateResult', 'üîÑ Checking login state...', 'info');
                
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    showResult('loginStateResult', '‚ùå No auth token found. Please login first.', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/auth/user/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    showResultHTML('loginStateResult', `
                        <h4>‚úÖ You are logged in!</h4>
                        <div class="token-display">
                            <strong>Username:</strong> ${userData.username}<br>
                            <strong>Email:</strong> ${userData.email}<br>
                            <strong>ID:</strong> ${userData.pk}
                        </div>
                    `, 'success');
                } else {
                    showResult('loginStateResult', '‚ùå Not logged in or token invalid', 'error');
                }
            } catch (error) {
                showResult('loginStateResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        function clearTokens() {
            localStorage.removeItem('authToken');
            showResult('loginStateResult', '‚úÖ All tokens cleared', 'success');
        }
        
        // Check URL parameters for OAuth callback
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (code) {
                showResult('googleLoginResult', `‚úÖ Google OAuth callback received! Code: ${code.substring(0, 20)}...`, 'success');
            } else if (error) {
                showResult('googleLoginResult', `‚ùå Google OAuth error: ${error}`, 'error');
            }
        };
    </script>
</body>
</html>
